<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Minha Equipe - Ganhos</title>
  <style>
    body {
      background-color: #121212;
      color: white;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      margin-bottom: 20px;
    }
    .profile span {
      font-size: 18px;
      font-weight: bold;
    }
    .details-btn {
      background-color: #8A2BE2;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .team-section, .invite-section {
      width: 100%;
      margin-bottom: 20px;
    }
    .team-level, .invite-code, .invite-link {
      background-color: #1e1e1e;
      margin: 10px 0;
      padding: 15px;
      border-radius: 8px;
    }
    .copy-btn {
      background-color: #8A2BE2;
      color: white;
      padding: 8px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 5px;
    }
    .footer {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 20px;
    }
    .bonus-info {
      font-size: 14px;
      margin-top: 10px;
      text-align: center;
    }
    .invited-list {
      background-color: #1e1e1e;
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
      width: 100%;
    }
  </style>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="profile">
        <span>Minha equipe</span>
      </div>
      <button class="details-btn" onclick="window.location.href='equipe.html'">Detalhes da equipe</button>
    </div>

    <section class="team-section">
      <div class="team-level">
        <div class="level">LV1</div>
        <div class="tax">35% Taxa de comissão</div>
        <div class="bonus" id="lv1-bonus">R$ 0,00 Bônus</div>
        <div class="status">Usuário válido</div>
      </div>
    </section>

    <section class="invite-section">
      <div class="invite-code">
        <span>Código de convite</span>
        <p id="invite-code">Carregando...</p>
        <button class="copy-btn" onclick="copyText('invite-code')">Cópia</button>
      </div>

      <div class="invite-link">
        <span>Link de convite</span>
        <p id="invite-link">Carregando...</p>
        <button class="copy-btn" onclick="copyText('invite-link')">Cópia</button>
      </div>

      <div class="invited-list">
        <strong>Usuários convidados:</strong>
        <ul id="invited-users" style="padding-left: 20px;"></ul>
      </div>
    </section>

    <footer class="footer">
      <span id="total-users">0 usuários convidados</span>
      <span id="total-bonus">R$ 0,00 ganhos totais</span>
      <div class="bonus-info">
        <p>Bônus de convite: Quando um amigo se registra e investe, você recebe 35% do valor investido.</p>
      </div>
    </footer>
  </div>

  <script>
    // Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCKSKnVC8dNWmiMrNr1j4rMLfQTlOrqzVM",
      authDomain: "hinvest-f4354.firebaseapp.com",
      databaseURL: "https://hinvest-f4354-default-rtdb.firebaseio.com",
      projectId: "hinvest-f4354",
      storageBucket: "hinvest-f4354.appspot.com",
      messagingSenderId: "646397677016",
      appId: "1:646397677016:web:f05ca27a38439568bff6ad"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function copyText(id) {
      const text = document.getElementById(id).textContent;
      navigator.clipboard.writeText(text).then(() => {
        alert("Copiado!");
      });
    }

    function getCodigoIndicado() {
      const params = new URLSearchParams(window.location.search);
      return params.get('codigo') || null;
    }

    async function gerarCodigoNovo() {
      const snapshot = await db.ref("usuarios").once("value");
      return snapshot.numChildren() + 1;
    }

    async function iniciarSistema() {
      let usuarioId = localStorage.getItem("usuarioId");
      let meuCodigo;
      let codigoIndicado = getCodigoIndicado();

      if (usuarioId) {
        const snapshot = await db.ref("usuarios/" + usuarioId).once("value");
        if (snapshot.exists()) {
          meuCodigo = snapshot.val().codigo;
        } else {
          usuarioId = null;
        }
      }

      if (!usuarioId) {
        meuCodigo = await gerarCodigoNovo();
        usuarioId = "usuario_" + meuCodigo;
        localStorage.setItem("usuarioId", usuarioId);

        const novoUsuario = {
          nome: "Usuário " + meuCodigo,
          investimento: 0,
          codigo: meuCodigo,
          codigoIndicado: codigoIndicado
        };
        await db.ref("usuarios/" + usuarioId).set(novoUsuario);
      }

      const linkConvite = `https://inves13.github.io/hivest-codigo-1?codigo=${meuCodigo}`;
      document.getElementById("invite-code").textContent = meuCodigo;
      document.getElementById("invite-link").textContent = linkConvite;

      db.ref("usuarios").orderByChild("codigoIndicado").equalTo(String(meuCodigo)).once("value", snapshot => {
        let totalBonus = 0;
        let totalUsers = 0;
        const list = document.getElementById("invited-users");
        list.innerHTML = "";

        snapshot.forEach(child => {
          const nome = child.val().nome;
          const investimento = parseFloat(child.val().investimento || 0);
          const bonus = investimento * 0.35;
          totalBonus += bonus;
          totalUsers++;

          const li = document.createElement("li");
          li.textContent = `${nome} - Investiu R$ ${investimento.toFixed(2)} - Você ganhou R$ ${bonus.toFixed(2)}`;
          list.appendChild(li);
        });

        document.getElementById("lv1-bonus").textContent = `R$ ${totalBonus.toFixed(2)} Bônus`;
        document.getElementById("total-bonus").textContent = `R$ ${totalBonus.toFixed(2)} ganhos totais`;
        document.getElementById("total-users").textContent = `${totalUsers} usuários convidados`;
      });
    }

    iniciarSistema();
  </script>
</body>
</html>
